name: üöÄ Deploy Laravel to Beget

on:
  push:
    branches:
      - master  # –¥–µ–ø–ª–æ–π —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø—É—à–µ –≤ master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üöÄ Deploy to Beget server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}       # <-- –¥–æ–±–∞–≤—å –≤ Secrets: SSH_HOST=ruslabq5.beget.tech
          username: ${{ secrets.SSH_USER }}   # <-- SSH_USER=ruslabq5
          key: ${{ secrets.SSH_KEY }}         # <-- –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á (–¥–æ–±–∞–≤—å —á–µ—Ä–µ–∑ Settings > Secrets > Actions)
          port: 22                            # —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–æ—Ä—Ç SSH
          script: |
            echo "üîó –ü–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É Beget"
            cd /home/r/ruslabq5/web-ruslan || exit 1

            echo "üì¶ –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –∏–∑ Git..."
            git pull origin master

            echo "üìö –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
            php8.3 ~/composer.phar install --no-dev --optimize-autoloader

            echo "üßπ –û—á–∏—â–∞–µ–º –∫–µ—à..."
            php8.3 artisan cache:clear
            php8.3 artisan config:clear
            php8.3 artisan route:clear
            php8.3 artisan view:clear
            php8.3 artisan event:clear

            echo "‚ö° –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è..."
            php8.3 artisan optimize

            echo "üîó –ü—Ä–æ–≤–µ—Ä—è–µ–º storage link..."
            if [ ! -L "public/storage" ]; then
              php8.3 artisan storage:link
            fi

            echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ!"
